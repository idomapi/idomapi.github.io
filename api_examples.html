<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Examples</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navbar Styles */
        .navbar {
            background: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2563eb;
        }

        .navbar-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Dropdown Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .dropdown-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .dropdown-arrow {
            transition: transform 0.2s ease;
        }

        .dropdown.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            min-width: 160px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1001;
        }

        .dropdown.active .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            direction: rtl;
            padding: 0.75rem 1rem;
            color: #374151;
            text-decoration: none;
            font-size: 0.875rem;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:hover {
            background: #f9fafb;
        }

        .dropdown-item:first-child {
            border-radius: 0.375rem 0.375rem 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 0.375rem 0.375rem;
        }

        /* Input Field Styles */
        .search-input {
            direction: rtl;
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            width: 200px;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Button Styles */
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        /* Main Content Styles */
        .main {
            flex: 1;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }

        #results-table-container {
            position: absolute;
            top: 1rem;
            right: 0.5rem;
            max-height: 65vh;
            background: rgba(255,255,255,0.97);
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            z-index: 10;
            padding: 1rem 0.5rem 1.5rem 0.5rem;
            overflow: hidden;
        }
        #results-table-container h3 {
            direction: rtl;
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            color: #1f2937;
        }
        #results-table {
            width: 40vw;
            border-collapse: collapse;
            margin-bottom: 0.5rem;
        }
        #results-table th, #results-table td {
            border: 1px solid #e5e7eb;
            padding: 0.4rem 0.6rem;
            text-align: right;
            font-size: 0.95rem;
        }
        #results-table tbody {
            display: block;
            max-height: 300px;
            overflow-y: auto;
            width: 100%;
        }
        #results-table thead, #results-table tbody tr {
            cursor: pointer;
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        #results-table th {
            background: #f3f4f6;
            color: #2563eb;
            position: sticky;
        }
        #results-table tr:hover {
            background: #f1f5f9;
        }

        /* Custom Footer Styles */
        footer.custom-footer {
            position: relative;
            height: 2.5rem;
            text-align: right;
            padding: 0 1.5rem;
        }
        footer.custom-footer p {
            font-size: 1.1rem;
            margin: 0;
            width: 100%;
            height: 100%;
        }
        footer.custom-footer a {
            color: #0044cc;
            text-decoration: none;
        }
        footer.custom-footer a:hover {
            text-decoration: underline;
        }
    </style>
    
    </head>
    
    <body>
    <!-- Navbar -->
    <nav class="navbar">
        <!-- <div class="navbar-brand">API Examples</div> -->
        <div class="navbar-controls">

        </div>
        <div class="navbar-controls">
            <!-- Button -->
            <button class="btn" id="searchBtn" onclick="handleSearch()" disabled>חיפוש</button>

            <!-- Text Input -->
            <input type="text" class="search-input" placeholder="כתובת">

            <!-- Dropdown Button -->
            <select id="drawType" class="dropdown-menu"></select>
            <div class="dropdown" id="dropdown">
                <button class="dropdown-btn" onclick="toggleDropdown()">
                    <span class="dropdown-arrow">▼</span>
                    צייר
                </button>
                <div class="dropdown-menu">
                    <a href="#" class="dropdown-item" onclick="selectFeaturesOnMap('Circle')">רדיוס</a>
                    <a href="#" class="dropdown-item" onclick="selectFeaturesOnMap('Polygon')">מצולע</a>
                    <a href="#" class="dropdown-item" onclick="selectFeaturesOnMap('FreehandPolygon')">שרטוט חופשי</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div id="map" style="width: 100%; height: 80vh;"></div>
    </main>

    <!-- Footer -->
    <footer class="custom-footer">
        <p>
            <a href="https://www.govmap.gov.il/">המרכז למיפוי ישראל 2025, אתר המפות הממשלתי ©</a>
        </p>
    </footer>

    <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" defer onload="initGovMap()"></script>
    <script>
        function initGovMap() {
            govmap.createMap('map', {
                token: '8afbb7f6-f247-4b73-9366-635aaa7c9b1f',
                visibleLayers: ['kids_g', 'school'],
                layers: ['kids_g', 'school', 'bus_stops'],
                layersMode: 2,
                showXY: true,
                identifyOnClick: true,
                isEmbeddedToggle: true
            });
        }

        var mockSearchResult = {
            "active": false,
            "data": [
                {
                    "Alert": null,
                    "DescLayerID": "ADDR",
                    "Gush": "",
                    "ObjectID": "259764",
                    "ObjectIDType": "number",
                    "ObjectKey": "ObjectID",
                    "Parcel": "",
                    "ResultLable": "זמיר 4 כפר סבא",
                    "ResultType": 1,
                    "showLotAddress": false,
                    "showLotParcel": false,
                    "X": 193422.19,
                    "Y": 676890.72
                }
            ],
            "errorCode": 0,
            "message": null,
            "status": 0
        };

        function handleSearch() {
            const searchInput = document.querySelector('.search-input');
            const searchTerm = searchInput.value.trim();
            console.log(`Searching for: ${searchTerm}`);

            govmap.geocode({keyword: searchTerm, type: govmap.geocodeType.AccuracyOnly})
            .then(function(response) {
                console.log(response);
                if (response.data && response.data.length > 0) {
                    const firstResult = response.data[0];
                    console.log(`Zooming to: ${firstResult.X}, ${firstResult.Y}`);
                    zoomToXY(firstResult.X, firstResult.Y);
                } else {
                    console.warn('לא נמצאו תוצאות');
                }
            });
        }

        function zoomToXY(x, y) {
            govmap.zoomToXY({x, y, level: 10, marker: true});
        }

        function selectFeaturesOnMap(type) {
            toggleDropdown();
            var drawType = {
                Circle: govmap.drawType.Circle,
                Polygon: govmap.drawType.Polygon,
                FreehandPolygon: govmap.drawType.FreehandPolygon,
            };
            var params = {
                continous: false,
                drawType: drawType[type],
                filterLayer: false,
                isZoomToExtent: true,
                layers: ['kids_g', 'school'],
                returnFields: {
                    'kids_g': ['shem_misgeret', 'mispar_bait', 'ktovet', 'shem_yishuv'],
                    'school': ['shem_misgeret', 'mispar_bait', 'ktovet', 'shem_yishuv']
                },
                whereClause: {
                    'kids_g': "(1 = 1)",
                    'school': "(1 = 1)"
                },
                getWkt: true
            };

            var results = {kindergarten: null, school: null};
            govmap.selectFeaturesOnMap(params).then(function(response) {
                response.forEach((layer, index) => {
                    if (!layer && layer.length === 0) {
                        results[index === 0 ? 'kindergarten' : 'school'] = [];
                    } else {
                        results[index === 0 ? 'kindergarten' : 'school'] = layer.map(item => {
                            var coords = item.wkt.replace("POINT (", "").replace(")", "").split(" ");
                            var x = parseFloat(coords[0]);
                            var y = parseFloat(coords[1]);
                            return {
                                name: item.shem_misgeret,
                                address: `${item.ktovet}${' ' + item.mispar_bait || ''}, ${item.shem_yishuv}`,
                                x,
                                y
                            };
                        });
                    }
                });

                if (results.kindergarten.length === 0 && results.school.length === 0) {
                    alert('לא נמצאו תוצאות בשטח זה');
                    return;
                }

                findNearbyBusStops(results);
            });

        }

        function getLayerData(x, y) {
            var params = {
                LayerName: 'bus_stops',
                Point: {x, y},
                Radius: 200,
            };

            return new Promise(resolve => govmap.getLayerData(params).then(response => resolve(response)));
        }

        function findNearbyBusStops(layers) {
            var results = {kindergarten: [], school: []};
            
            // Collect unique (x, y) pairs
            const coordMap = new Map();
            Object.keys(layers).forEach(layerKey => {
                if (layers[layerKey] && layers[layerKey].length > 0) {
                    layers[layerKey].forEach(feature => {
                        const key = `${feature.x},${feature.y}`;
                        if (!coordMap.has(key)) {
                            coordMap.set(key, []);
                        }
                        coordMap.get(key).push({feature, layerKey});
                    });
                }
            });

            var promises = [];
            coordMap.forEach((featureList, key) => {
                var [x, y] = key.split(',').map(Number);
                var p = getLayerData(x, y).then(response => {
                    var busStop = {};

                    if (response.data && response.data.length > 0) {
                        busStop = {
                            x: response.data[0].fields[0].value,
                            y: response.data[0].fields[1].value,
                            stopName: response.data[0].fields[2].value,
                            distance: response.data[0].distance
                        }
                    }

                    featureList.forEach(({feature, layerKey}) => {
                        results[layerKey].push({...feature, busStop});
                    });
                });
                promises.push(p);
            });

            Promise.all(promises).then(() => {
                console.log('00000results', results);
                createTable(results);
            });
        }
        function createTable(data) {
            // Remove old table if exists
            let old = document.getElementById('results-table-container');
            if (old) old.remove();

            // If no data, do nothing
            if (!data || (!data.kindergarten && !data.school)) return;

            // Create container
            const container = document.createElement('div');
            container.id = 'results-table-container';

            // Add table title
            const title = document.createElement('h3');
            title.textContent = 'תוצאות חיפוש';
            container.appendChild(title);

            // Create tabs
            const tabs = document.createElement('div');
            tabs.style.cssText = 'display:flex;gap:0.5rem;';
            const tabKindergarten = document.createElement('button');
            tabKindergarten.textContent = 'גני ילדים';
            tabKindergarten.style.cssText = 'flex:1;padding:0.4rem 0.2rem;border:none;border-bottom:2px solid #2563eb;background:#f3f4f6;color:#2563eb;font-size: 1rem;font-weight:bold;cursor:pointer;border-radius:0.5rem 0.5rem 0 0;';
            const tabSchool = document.createElement('button');
            tabSchool.textContent = 'בתי ספר';
            tabSchool.style.cssText = 'flex:1;padding:0.4rem 0.2rem;border:none;border-bottom:2px solid transparent;background:#f3f4f6;color:#1f2937;font-size: 1rem;font-weight:bold;cursor:pointer;border-radius:0.5rem 0.5rem 0 0;';
            tabs.appendChild(tabSchool);
            tabs.appendChild(tabKindergarten);
            container.appendChild(tabs);

            // Create sheets
            const sheetKindergarten = document.createElement('div');
            const sheetSchool = document.createElement('div');
            sheetKindergarten.style.display = '';
            sheetSchool.style.display = 'none';

            // Helper to create a table for a sheet
            function makeTable(arr) {
                const table = document.createElement('table');
                table.id = 'results-table';
                const thead = document.createElement('thead');
                thead.innerHTML = `<tr><th>תחנת אוטובוס קרובה</th><th>כתובת</th><th>שם</th></tr>`;
                table.appendChild(thead);
                const tbody = document.createElement('tbody');
                arr.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    tr.id = `row-${index}`;
                    tr.setAttribute('onclick', `handleBusStopsClick(${item.busStop.x}, ${item.busStop.y})`);
                    tr.innerHTML = `
                        <td>${item.busStop && item.busStop.stopName ? item.busStop.stopName : ''}</td>
                        <td>${item.address || ''}</td>
                        <td>${item.name || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                return table;
            }

            if (data.kindergarten && data.kindergarten.length) {
                sheetKindergarten.appendChild(makeTable(data.kindergarten));
            } else {
                sheetKindergarten.textContent = 'אין נתונים.';
            }

            if (data.school && data.school.length) {
                sheetSchool.appendChild(makeTable(data.school));
            } else {
                sheetSchool.textContent = 'אין נתונים.';
            }

            container.appendChild(sheetKindergarten);
            container.appendChild(sheetSchool);

            // Tab switching logic
            tabKindergarten.onclick = function() {
                sheetKindergarten.style.display = '';
                sheetSchool.style.display = 'none';
                tabKindergarten.style.borderBottom = '2px solid #2563eb';
                tabKindergarten.style.color = '#2563eb';
                tabSchool.style.borderBottom = '2px solid transparent';
                tabSchool.style.color = '#1f2937';
            };
            tabSchool.onclick = function() {
                sheetKindergarten.style.display = 'none';
                sheetSchool.style.display = '';
                tabKindergarten.style.borderBottom = '2px solid transparent';
                tabKindergarten.style.color = '#1f2937';
                tabSchool.style.borderBottom = '2px solid #2563eb';
                tabSchool.style.color = '#2563eb';
            };

            // Add close button
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '✕';
            closeBtn.style.cssText = 'position:absolute;top:0.5rem;left:0.5rem;background:none;border:none;font-size:1.2rem;cursor:pointer;color:#888;';
            closeBtn.onclick = () => container.remove();
            container.appendChild(closeBtn);

            // Add to DOM
            const main = document.querySelector('.main');
            main.appendChild(container);
        }

        function handleBusStopsClick(x, y) {
            govmap.setVisibleLayers(['bus_stops']);
            zoomToXY(x, y);
        }

        // Call with mock data for development
        createTable();
        </script>
        <script>
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdown');
            dropdown.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const dropdown = document.getElementById('dropdown');
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });



        // Enable/disable Search button based on input
        const searchInput = document.querySelector('.search-input');
        const searchBtn = document.getElementById('searchBtn');
        function updateSearchBtn() {
            searchBtn.disabled = searchInput.value.trim() === '';
        }
        searchInput.addEventListener('input', updateSearchBtn);
        // Initial state
        updateSearchBtn();

        // Handle Enter key in search input
        searchInput.addEventListener('keypress', function (event) {
            if (event.key === 'Enter' && !searchBtn.disabled) {
                handleSearch();
            }
        });
    </script>
</body>

</html>